<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的像素日记 Pro</title>
    <style>
        :root {
            --primary: #a8dadc;
            --bg: #f0f2f5;
            --text: #457b9d;
            --card-shadow: 0 10px 30px rgba(0,0,0,0.08);
        }

        body { 
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif; 
            background-color: var(--bg); 
            margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center; 
            color: #333;
        }

        /* 顶部页签 */
        .tab-bar {
            display: flex; gap: 8px; margin-bottom: 15px; width: 100%; max-width: 950px;
            overflow-x: auto; padding: 5px;
        }
        .tab {
            padding: 6px 15px; background: #e0e0e0; border-radius: 15px;
            cursor: pointer; font-size: 13px; color: #666; transition: 0.3s;
        }
        .tab.active { background: var(--text); color: white; }

        /* 主容器：像一张白纸 */
        .main-container { 
            background: white; 
            padding: 50px; 
            border-radius: 12px; 
            box-shadow: var(--card-shadow);
            display: flex;
            flex-direction: column; /* 纵向排列标题和下方内容 */
            align-items: center;
            min-width: 800px;
        }

        /* 标题在白纸内部 */
        #title { 
            font-size: 28px; font-weight: bold; margin-bottom: 40px; 
            border: none; background: transparent; text-align: center; 
            color: #333; outline: none; width: 100%;
            border-bottom: 1px dashed #eee; padding-bottom: 10px;
        }

        /* 内容布局：表格与图例横向排列 */
        .content-layout {
            display: flex;
            flex-direction: row;
            align-items: center; /* 关键：让右侧图例垂直居中于表格 */
            gap: 50px; /* 表格与图例的间距 */
        }

        /* 网格 */
        .grid-wrapper { display: grid; grid-template-columns: 30px repeat(12, 22px); gap: 4px; }
        .cell { 
            width: 22px; height: 22px; border: 1px solid #f0f0f0; 
            background-color: #fff; cursor: pointer; border-radius: 3px; 
        }
        .header-cell { font-size: 10px; display: flex; align-items: center; justify-content: center; color: #ccc; }

        /* 右侧图例 */
        .legend { 
            display: flex; flex-direction: column; gap: 15px; 
            padding: 20px; border-left: 1px solid #f9f9f9;
        }
        .legend-item { display: flex; align-items: center; gap: 12px; }
        .color-picker { 
            width: 24px; height: 24px; border: none; padding: 0; 
            cursor: pointer; border-radius: 4px; 
        }
        .legend-text { 
            border: none; border-bottom: 1px solid #f0f0f0; outline: none; 
            font-size: 14px; width: 80px; color: #444;
        }
        .active-legend { transform: scale(1.2); box-shadow: 0 0 0 2px #333; }

        .btn-delete { 
            margin-top: 30px; padding: 8px 20px; border-radius: 8px; 
            border: none; background: #fff1f0; color: #ff4d4f; cursor: pointer;
        }
    </style>
</head>
<body>

    <div class="tab-bar" id="tabBar"></div>

    <div class="main-container">
        <input type="text" id="title" placeholder="这一页的标题..." oninput="updateCurrentPageTitle()">

        <div class="content-layout">
            <div id="pixelGrid" class="grid-wrapper"></div>

            <div class="legend" id="legend">
                </div>
        </div>
    </div>

    <button class="btn-delete" onclick="deleteCurrentPage()">删除此页</button>

    <script>
        let pages = JSON.parse(localStorage.getItem('pixelAppData')) || [createNewPageObject("2024 年度心情追踪")];
        let activeIdx = 0;
        let currentColor = "";

        const grid = document.getElementById('pixelGrid');
        const tabBar = document.getElementById('tabBar');
        const legendContainer = document.getElementById('legend');

        function createNewPageObject(title) {
            return {
                title: title,
                legendColors: ["#D1C4E9", "#FFCDD2", "#C8E6C9", "#BBDEFB", "#F5F5F5"],
                legendTexts: ["平静", "开心", "高效", "疲惫", "一般"],
                cells: {}
            };
        }

        function init() {
            renderTabs();
            renderPage();
        }

        function renderTabs() {
            tabBar.innerHTML = '';
            pages.forEach((page, index) => {
                const tab = document.createElement('div');
                tab.className = `tab ${index === activeIdx ? 'active' : ''}`;
                tab.innerText = page.title || `未命名`;
                tab.onclick = () => { activeIdx = index; renderPage(); renderTabs(); };
                tabBar.appendChild(tab);
            });
            const addBtn = document.createElement('div');
            addBtn.className = 'tab';
            addBtn.style.background = "#ddd";
            addBtn.innerText = '+';
            addBtn.onclick = () => { pages.push(createNewPageObject("新页面")); activeIdx = pages.length-1; saveAndRefresh(); };
            tabBar.appendChild(addBtn);
        }

        function renderPage() {
            const page = pages[activeIdx];
            document.getElementById('title').value = page.title;
            
            legendContainer.innerHTML = '<div style="font-size:12px; color:#999; margin-bottom:10px;">图例</div>';
            page.legendColors.forEach((color, i) => {
                const item = document.createElement('div');
                item.className = 'legend-item';
                item.innerHTML = `
                    <input type="color" class="color-picker ${i===0?'active-legend':''}" value="${color}" 
                        onchange="updateLegendData(${i}, 'color', this.value)" onclick="selectColor(this)">
                    <input type="text" class="legend-text" value="${page.legendTexts[i]}" 
                        oninput="updateLegendData(${i}, 'text', this.value)">
                `;
                legendContainer.appendChild(item);
                if(i===0) currentColor = color;
            });

            const months = ['J', 'F', 'M', 'A', 'M', 'J', 'J', 'A', 'S', 'O', 'N', 'D'];
            grid.innerHTML = `<div class="header-cell"></div>`;
            months.forEach(m => grid.innerHTML += `<div class="header-cell">${m}</div>`);

            for (let row = 1; row <= 31; row++) {
                grid.innerHTML += `<div class="header-cell">${row}</div>`;
                for (let col = 1; col <= 12; col++) {
                    const id = `cell-${col}-${row}`;
                    const color = page.cells[id] || '#fff';
                    grid.innerHTML += `<div class="cell" id="${id}" style="background-color: ${color}" onclick="fillCell(this)"></div>`;
                }
            }
        }

        function selectColor(el) {
            currentColor = el.value;
            document.querySelectorAll('.color-picker').forEach(p => p.classList.remove('active-legend'));
            el.classList.add('active-legend');
        }

        function fillCell(el) {
            const page = pages[activeIdx];
            if (rgbToHex(el.style.backgroundColor).toUpperCase() === currentColor.toUpperCase()) {
                el.style.backgroundColor = "#fff";
                delete page.cells[el.id];
            } else {
                el.style.backgroundColor = currentColor;
                page.cells[el.id] = currentColor;
            }
            saveToLocal();
        }

        function updateCurrentPageTitle() {
            pages[activeIdx].title = document.getElementById('title').value;
            saveToLocal();
            renderTabs();
        }

        function updateLegendData(index, type, value) {
            if(type === 'color') pages[activeIdx].legendColors[index] = value;
            else pages[activeIdx].legendTexts[index] = value;
            saveToLocal();
        }

        function deleteCurrentPage() {
            if (pages.length <= 1 || !confirm("确定删除吗？")) return;
            pages.splice(activeIdx, 1);
            activeIdx = 0;
            saveAndRefresh();
        }

        function saveToLocal() { localStorage.setItem('pixelAppData', JSON.stringify(pages)); }
        function saveAndRefresh() { saveToLocal(); init(); }
        function rgbToHex(rgb) {
            if (!rgb || rgb.startsWith("#")) return rgb || "";
            const vals = rgb.match(/\d+/g);
            return "#" + vals.map(x => parseInt(x).toString(16).padStart(2, '0')).join("");
        }

        init();
    </script>
</body>
</html>
