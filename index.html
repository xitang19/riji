<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的像素日记 Pro</title>
    <style>
        :root {
            --primary: #a8dadc;
            --bg: #f8f9fa;
            --text: #457b9d;
            --card-shadow: 0 10px 25px rgba(0,0,0,0.05);
        }

        body { 
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif; 
            background-color: var(--bg); 
            margin: 0; padding: 40px 20px;
            display: flex; flex-direction: column; align-items: center; 
            color: #333;
        }

        /* 顶部标签栏 - 类似 Excel 的工作表 */
        .tab-bar {
            display: flex; gap: 10px; margin-bottom: 20px; width: 100%; max-width: 800px;
            overflow-x: auto; padding: 10px 0;
        }
        .tab {
            padding: 8px 20px; background: white; border-radius: 20px;
            cursor: pointer; box-shadow: var(--card-shadow); font-size: 14px;
            white-space: nowrap; transition: 0.3s; border: 2px solid transparent;
        }
        .tab.active { background: var(--primary); color: white; font-weight: bold; }
        .add-tab { background: #eee; font-weight: bold; }

        /* 主容器 */
        #title { 
            font-size: 32px; font-weight: bold; margin-bottom: 30px; 
            border: none; background: transparent; text-align: center; 
            color: var(--text); outline: none; width: 100%;
        }

        .main-container { 
            display: flex; flex-wrap: wrap; gap: 40px; 
            background: white; padding: 40px; border-radius: 24px; 
            box-shadow: var(--card-shadow); justify-content: center;
        }

        /* 网格美化 */
        .grid-wrapper { display: grid; grid-template-columns: 35px repeat(12, 25px); gap: 4px; }
        .cell { 
            width: 25px; height: 25px; border: 1px solid #f0f0f0; 
            background-color: #fff; cursor: pointer; border-radius: 4px; 
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .cell:hover { transform: scale(1.2); box-shadow: 0 4px 8px rgba(0,0,0,0.1); z-index: 10; }
        .header-cell { font-size: 10px; display: flex; align-items: center; justify-content: center; color: #bbb; font-weight: bold; }

        /* 图例美化 */
        .legend { display: flex; flex-direction: column; gap: 20px; min-width: 180px; }
        .legend-item { display: flex; align-items: center; gap: 12px; }
        .color-picker { 
            width: 32px; height: 32px; border: none; padding: 0; 
            cursor: pointer; border-radius: 50%; overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .legend-text { 
            border: none; border-bottom: 1px solid #eee; outline: none; 
            font-size: 15px; padding: 4px; width: 100px; color: #666;
        }
        .active-legend { transform: scale(1.2); outline: 2px solid var(--text); outline-offset: 3px; }

        .btn-group { margin-top: 40px; display: flex; gap: 15px; }
        .btn { 
            padding: 10px 24px; border-radius: 12px; border: none; 
            cursor: pointer; font-size: 14px; transition: 0.3s;
        }
        .btn-delete { background: #ffeded; color: #ff7675; }
        .btn-delete:hover { background: #ff7675; color: white; }
    </style>
</head>
<body>

    <div class="tab-bar" id="tabBar">
        </div>

    <input type="text" id="title" placeholder="给这一页起个名字..." oninput="updateCurrentPageTitle()">

    <div class="main-container">
        <div id="pixelGrid" class="grid-wrapper"></div>

        <div class="legend" id="legend">
            <div style="font-weight: bold; color: #999; margin-bottom: 5px;">图例设置</div>
            </div>
    </div>

    <div class="btn-group">
        <button class="btn btn-delete" onclick="deleteCurrentPage()">删除当前页</button>
    </div>

    <script>
        // --- 数据结构说明 ---
        // pages = [ {title: "", colors: [], texts: [], cells: {}}, ... ]
        let pages = JSON.parse(localStorage.getItem('pixelAppData')) || [createNewPageObject("第一页")];
        let activeIdx = 0;
        let currentColor = "";

        const grid = document.getElementById('pixelGrid');
        const tabBar = document.getElementById('tabBar');
        const legendContainer = document.getElementById('legend');

        // 1. 初始化
        function init() {
            renderTabs();
            renderPage();
        }

        function createNewPageObject(title) {
            return {
                title: title,
                legendColors: ["#D1C4E9", "#FFCDD2", "#C8E6C9", "#BBDEFB", "#F5F5F5"],
                legendTexts: ["平静", "开心", "高效", "疲惫", "一般"],
                cells: {}
            };
        }

        // 2. 渲染标签栏
        function renderTabs() {
            tabBar.innerHTML = '';
            pages.forEach((page, index) => {
                const tab = document.createElement('div');
                tab.className = `tab ${index === activeIdx ? 'active' : ''}`;
                tab.innerText = page.title || `未命名 ${index + 1}`;
                tab.onclick = () => { activeIdx = index; renderPage(); renderTabs(); };
                tabBar.appendChild(tab);
            });
            const addBtn = document.createElement('div');
            addBtn.className = 'tab add-tab';
            addBtn.innerText = '+ 新增页';
            addBtn.onclick = addNewPage;
            tabBar.appendChild(addBtn);
        }

        function addNewPage() {
            pages.push(createNewPageObject("新页面"));
            activeIdx = pages.length - 1;
            saveAndRefresh();
        }

        // 3. 渲染当前页面内容
        function renderPage() {
            const page = pages[activeIdx];
            document.getElementById('title').value = page.title;
            
            // 渲染图例
            legendContainer.innerHTML = '<div style="font-weight: bold; color: #999; margin-bottom: 5px;">图例设置</div>';
            page.legendColors.forEach((color, i) => {
                const item = document.createElement('div');
                item.className = 'legend-item';
                item.innerHTML = `
                    <input type="color" class="color-picker ${i===0?'active-legend':''}" value="${color}" 
                        onchange="updateLegendData(${i}, 'color', this.value)" onclick="selectColor(this)">
                    <input type="text" class="legend-text" value="${page.legendTexts[i]}" 
                        oninput="updateLegendData(${i}, 'text', this.value)">
                `;
                legendContainer.appendChild(item);
                if(i===0) currentColor = color;
            });

            // 渲染网格
            const months = ['J', 'F', 'M', 'A', 'M', 'J', 'J', 'A', 'S', 'O', 'N', 'D'];
            grid.innerHTML = `<div class="header-cell"></div>`;
            months.forEach(m => grid.innerHTML += `<div class="header-cell">${m}</div>`);

            for (let row = 1; row <= 31; row++) {
                grid.innerHTML += `<div class="header-cell">${row}</div>`;
                for (let col = 1; col <= 12; col++) {
                    const id = `cell-${col}-${row}`;
                    const color = page.cells[id] || '#fff';
                    grid.innerHTML += `<div class="cell" id="${id}" style="background-color: ${color}" onclick="fillCell(this)"></div>`;
                }
            }
        }

        // 4. 数据操作
        function updateCurrentPageTitle() {
            pages[activeIdx].title = document.getElementById('title').value;
            localStorage.setItem('pixelAppData', JSON.stringify(pages));
            renderTabs(); // 实时更新标签名
        }

        function updateLegendData(index, type, value) {
            if(type === 'color') pages[activeIdx].legendColors[index] = value;
            else pages[activeIdx].legendTexts[index] = value;
            saveToLocal();
        }

        function selectColor(el) {
            currentColor = el.value;
            document.querySelectorAll('.color-picker').forEach(p => p.classList.remove('active-legend'));
            el.classList.add('active-legend');
        }

        function fillCell(el) {
            const page = pages[activeIdx];
            const hexColor = rgbToHex(el.style.backgroundColor);
            if (hexColor.toUpperCase() === currentColor.toUpperCase()) {
                el.style.backgroundColor = "#fff";
                delete page.cells[el.id];
            } else {
                el.style.backgroundColor = currentColor;
                page.cells[el.id] = currentColor;
            }
            saveToLocal();
        }

        function deleteCurrentPage() {
            if (pages.length <= 1) return alert("至少保留一页哦！");
            if (confirm("确定删除这一页吗？")) {
                pages.splice(activeIdx, 1);
                activeIdx = 0;
                saveAndRefresh();
            }
        }

        function saveToLocal() {
            localStorage.setItem('pixelAppData', JSON.stringify(pages));
        }

        function saveAndRefresh() {
            saveToLocal();
            init();
        }

        function rgbToHex(rgb) {
            if (!rgb || rgb.startsWith("#")) return rgb || "";
            const vals = rgb.match(/\d+/g);
            return "#" + vals.map(x => parseInt(x).toString(16).padStart(2, '0')).join("");
        }

        init();
    </script>
</body>
</html>
