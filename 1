<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的年度像素日记</title>
    <style>
        :root { --bg-color: #f4f7f6; --card-bg: #ffffff; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg-color); display: flex; flex-direction: column; align-items: center; padding: 20px; color: #333; }
        
        #title { font-size: 28px; font-weight: bold; margin-bottom: 20px; border: none; background: transparent; text-align: center; width: 80%; outline: none; border-bottom: 2px dashed #ccc; padding: 5px; }

        .main-container { display: flex; gap: 50px; background: var(--card-bg); padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }

        /* 网格 */
        .grid-wrapper { display: grid; grid-template-columns: 35px repeat(12, 25px); gap: 3px; }
        .cell { width: 25px; height: 25px; border: 1px solid #eee; background-color: #fff; cursor: pointer; border-radius: 3px; transition: transform 0.1s; }
        .cell:hover { transform: scale(1.1); z-index: 10; border-color: #aaa; }
        .header-cell { font-size: 11px; display: flex; align-items: center; justify-content: center; color: #999; font-weight: 600; }

        /* 图例 */
        .legend { display: flex; flex-direction: column; gap: 15px; min-width: 150px; }
        .legend-title { font-size: 14px; font-weight: bold; color: #666; margin-bottom: 10px; }
        .legend-item { display: flex; align-items: center; gap: 10px; }
        .color-picker { width: 30px; height: 30px; border: 2px solid #eee; padding: 0; cursor: pointer; border-radius: 5px; overflow: hidden; }
        .legend-text { border: none; border-bottom: 1px solid #eee; outline: none; font-size: 14px; padding: 2px; width: 80px; }
        
        .active-legend { border: 2px solid #333 !important; box-shadow: 0 0 5px rgba(0,0,0,0.2); }

        .btn-clear { margin-top: 30px; padding: 8px 20px; background: #ff7675; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px; }
    </style>
</head>
<body>

    <input type="text" id="title" placeholder="输入年度标题 (如: 2024 我的情绪地图)" oninput="saveData()">

    <div class="main-container">
        <div id="pixelGrid" class="grid-wrapper">
            </div>

        <div class="legend" id="legend">
            <div class="legend-title">选择心情/状态：</div>
            <div class="legend-item">
                <input type="color" class="color-picker active-legend" value="#D1C4E9" onchange="updateLegendColor(this)" onclick="selectColor(this)">
                <input type="text" class="legend-text" value="平静" oninput="saveData()">
            </div>
            <div class="legend-item">
                <input type="color" class="color-picker" value="#FFCDD2" onchange="updateLegendColor(this)" onclick="selectColor(this)">
                <input type="text" class="legend-text" value="开心" oninput="saveData()">
            </div>
            <div class="legend-item">
                <input type="color" class="color-picker" value="#C8E6C9" onchange="updateLegendColor(this)" onclick="selectColor(this)">
                <input type="text" class="legend-text" value="高效" oninput="saveData()">
            </div>
            <div class="legend-item">
                <input type="color" class="color-picker" value="#BBDEFB" onchange="updateLegendColor(this)" onclick="selectColor(this)">
                <input type="text" class="legend-text" value="疲惫" oninput="saveData()">
            </div>
            <div class="legend-item">
                <input type="color" class="color-picker" value="#F5F5F5" onchange="updateLegendColor(this)" onclick="selectColor(this)">
                <input type="text" class="legend-text" value="一般" oninput="saveData()">
            </div>
        </div>
    </div>

    <button class="btn-clear" onclick="clearAll()">清空所有数据</button>

    <script>
        let currentColor = "#D1C4E9";
        const grid = document.getElementById('pixelGrid');
        const months = ['J', 'F', 'M', 'A', 'M', 'J', 'J', 'A', 'S', 'O', 'N', 'D'];

        // 1. 初始化网格
        function initGrid() {
            grid.innerHTML = `<div class="header-cell"></div>`;
            months.forEach(m => grid.innerHTML += `<div class="header-cell">${m}</div>`);

            for (let row = 1; row <= 31; row++) {
                grid.innerHTML += `<div class="header-cell">${row}</div>`;
                for (let col = 1; col <= 12; col++) {
                    // 为每个格子设置唯一的 ID，方便保存，格式如 cell-1-1 (1月1日)
                    grid.innerHTML += `<div class="cell" id="cell-${col}-${row}" onclick="fillCell(this)"></div>`;
                }
            }
        }

        // 2. 选择颜色
        function selectColor(element) {
            currentColor = element.value;
            document.querySelectorAll('.color-picker').forEach(el => el.classList.remove('active-legend'));
            element.classList.add('active-legend');
        }

        function updateLegendColor(element) {
            currentColor = element.value;
            saveData();
        }

        // 3. 填充格子
        function fillCell(element) {
            // 如果已经是这个颜色，点击则变回白色（取消填充）
            const targetColor = rgbToHex(element.style.backgroundColor);
            if (targetColor.toUpperCase() === currentColor.toUpperCase()) {
                element.style.backgroundColor = "#fff";
            } else {
                element.style.backgroundColor = currentColor;
            }
            saveData();
        }

        // 4. 保存数据到 LocalStorage
        function saveData() {
            const data = {
                title: document.getElementById('title').value,
                legendTexts: Array.from(document.querySelectorAll('.legend-text')).map(el => el.value),
                legendColors: Array.from(document.querySelectorAll('.color-picker')).map(el => el.value),
                cells: {}
            };
            // 遍历所有格子保存颜色
            document.querySelectorAll('.cell').forEach(cell => {
                if (cell.style.backgroundColor && cell.style.backgroundColor !== "rgb(255, 255, 255)" && cell.style.backgroundColor !== "white") {
                    data.cells[cell.id] = cell.style.backgroundColor;
                }
            });
            localStorage.setItem('pixelJournalData', JSON.stringify(data));
        }

        // 5. 加载数据
        function loadData() {
            const savedData = localStorage.getItem('pixelJournalData');
            if (!savedData) return;
            const data = JSON.parse(savedData);

            document.getElementById('title').value = data.title || "";
            
            const texts = document.querySelectorAll('.legend-text');
            const colors = document.querySelectorAll('.color-picker');
            data.legendTexts.forEach((txt, i) => texts[i].value = txt);
            data.legendColors.forEach((clr, i) => colors[i].value = clr);

            // 恢复格子颜色
            for (const id in data.cells) {
                const cell = document.getElementById(id);
                if (cell) cell.style.backgroundColor = data.cells[id];
            }
        }

        // 辅助函数：RGB转Hex
        function rgbToHex(rgb) {
            if (!rgb) return "";
            if (rgb.startsWith("#")) return rgb;
            const rgbValues = rgb.match(/\d+/g);
            if (!rgbValues) return "";
            return "#" + rgbValues.map(x => {
                const hex = parseInt(x).toString(16);
                return hex.length === 1 ? "0" + hex : hex;
            }).join("");
        }

        function clearAll() {
            if(confirm("确定要清空所有数据吗？此操作不可撤销。")) {
                localStorage.removeItem('pixelJournalData');
                location.reload();
            }
        }

        initGrid();
        loadData();
    </script>
</body>
</html>
